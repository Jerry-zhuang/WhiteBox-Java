---
icon: bars-sort
---

# 什么是XXE

XXE（XML External Entity）漏洞，即 XML 外部实体注入漏洞，是一种在处理 XML 输入时可能出现的安全漏洞。

## 一、背景知识

### **1. XML 基础**

* XML（可扩展标记语言）是一种用于存储和传输数据的标记语言。它具有自定义标签的特点，被广泛应用于数据交换、配置文件等诸多场景。例如，一个简单的 XML 文档可能如下：

```xml
<?xml version="1.0" encoding="UTF - 8"?>
<bookstore>
    <book category="COOKING">
        <title lang="en">Everyday Italian</title>
        <author>Giada De Laurentiis</author>
        <year>2005</year>
        <price>30.00</price>
    </book>
</bookstore>
```

* XML 文档有自己的语法规则，包括标签的定义、元素的嵌套等。其中一个重要的概念是实体，实体是用于定义引用数据的快捷方式。例如，`&lt;`是`<`的实体引用，这在 XML 中用于表示小于号，以避免与标签语法冲突。

### **2. 实体类型**

* XML 中有内部实体和外部实体之分。内部实体是在 XML 文档内部定义的实体，如：

```xml
<?xml version="1.0" encoding="UTF - 8"?>
<!DOCTYPE root [
    <!ENTITY myEntity "This is an internal entity">
]>
<root>&myEntity;</root>
```

* 这里定义了一个名为`myEntity`的内部实体，在`root`元素中通过`&myEntity;`来引用它。外部实体则是引用外部资源的实体，这就是 XXE 漏洞产生的关键所在。

## **二、XXE 漏洞原理**

### **1. 漏洞产生原因**

* 当应用程序解析 XML 输入时，如果没有对 XML 外部实体进行正确的限制，攻击者就可以构造恶意的 XML 内容，使解析器加载外部实体。例如，攻击者可以构造一个 XML 文档，让应用程序去访问服务器上的敏感文件或者执行其他恶意操作。
* 假设一个 Java 应用程序有一个功能是解析用户提交的 XML 订单信息。如果没有对 XML 解析进行安全配置，攻击者就可以通过以下恶意 XML 进行攻击：

```xml
<?xml version="1.0" encoding="UTF - 8"?>
<!DOCTYPE root [
    <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>&xxe;</root>
```

* 这里定义了一个外部实体`xxe`，它指向了 Linux 系统下的`/etc/passwd`文件。当存在漏洞的应用程序解析这个 XML 时，就会读取`/etc/passwd`文件的内容并返回给攻击者，从而导致敏感信息泄露。

### **2. 攻击方式**

* **文件读取**：如上述例子，攻击者可以通过构造`file://`协议的外部实体来读取服务器上的各种文件。除了系统配置文件外，还可能包括数据库配置文件、应用程序的日志文件等。例如，在 Java 应用中，如果使用了某些数据库连接池，配置文件可能包含数据库的用户名、密码等敏感信息。
* **内部端口扫描**：攻击者可以利用`http://`或`https://`协议来尝试访问内部网络的其他服务。通过构造不同的 IP 地址和端口的外部实体 URL，判断哪些端口是开放的。例如，尝试`<!DOCTYPE root [<!ENTITY xxe SYSTEM "http://192.168.1.10:8080">]><root>&xxe;</root>`来查看内部 IP 为`192.168.1.10`的服务器上`8080`端口是否开放。
* **远程代码执行（在某些复杂场景下）**：虽然不是所有的 XXE 漏洞都能直接导致远程代码执行，但在一些特定的环境和配置下，通过利用外部实体引用与服务器上其他可执行程序或服务的交互，可能会导致代码执行。比如，如果服务器上有一个存在漏洞的脚本解释器，并且 XXE 漏洞可以引导解析器与之交互，就有可能执行恶意脚本。

## **三、XXE 漏洞的危害**

1. **数据泄露**
   * 这是最常见的危害。攻击者可以获取服务器上的敏感文件内容，如密码文件、配置文件、用户数据等。这些数据一旦泄露，可能会导致用户账号被盗用、系统被进一步入侵等严重后果。
2. **系统信息暴露**
   * 通过扫描内部端口等方式，攻击者可以了解服务器的网络架构和运行的服务，为后续更复杂的攻击（如分布式拒绝服务攻击（DDoS）或更有针对性的漏洞利用）提供信息。
3. **业务逻辑破坏**
   * 在一些情况下，攻击者可以通过篡改 XML 数据或者利用 XXE 漏洞对系统的正常业务逻辑产生影响。例如，修改订单信息、篡改用户权限设置等。

## **四、防范措施**

### **1. 禁用外部实体解析**

* 在 Java 中，使用 XML 解析库（如 DOM4J、JAXB 等）时，可以通过配置来禁用外部实体解析。例如，在使用 JAXB 解析 XML 时，可以设置`XMLInputFactory`的属性来禁止外部实体解析：

```java
XMLInputFactory xif = XMLInputFactory.newFactory();
xif.setProperty(XMLInputFactory.SUPPORT_DTD, false);
xif.setProperty(XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES, false);
```

### **2. 输入验证和过滤**

* 对用户输入的 XML 数据进行严格的验证和过滤。检查 XML 文档是否包含外部实体定义，对于可疑的实体引用进行拦截。可以使用正则表达式或者专门的 XML 验证工具来实现。

### **3. 安全的 XML 解析器配置**

* 选择安全的 XML 解析器版本，并根据最佳实践进行配置。一些解析器可能默认有一定的安全设置，但在复杂的应用环境中，需要仔细检查和调整这些设置以防止 XXE 漏洞。
